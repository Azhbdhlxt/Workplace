/***********************main.c**************************/

#include <Delay.h>
#include <reg51.h>

#include <lcd1602.h>

/***********************引脚定义************************/
sbit K1=P2^3;					//切换。=1调整时间、=2调整闹钟、=0正常运行
sbit K2=P2^4;					//下一个
sbit K3=P2^5;					//加一
sbit K4=P2^6;					//减一
sbit beep=P2^7;					//蜂鸣器
/***********************变量定义************************/
unsigned char moshi=0;					//用来指示当前处在哪个功能状态
unsigned int  timer=0;					//系统定时变量
unsigned char miao=0,fen=10,shi=6;		//初始时间
unsigned char buzzr_fen=12,buzzr_shi=6;	//闹钟时间
unsigned char two=0;					//指示每个功能下对应的时间
unsigned char time[]={"06:10:10"};		//当前时间显示空间
unsigned char buzzr[]={"06:12"};		//闹钟缓存
/*********************************************************
函数名称：delay
函数作用：延时函数
输入变量：unsigned int i延时时间
返回值：  无
***********************************************************/

/*********************************************************
函数名称：main
函数作用：主函数
输入变量：无
返回值：  无
***********************************************************/
void main()
{
	TMOD|=0X01;							//T0工作方式1
	TH0=0XfC;							//设置初值1ms
	TL0=0X18;	
	ET0=1;								//打开定时器0中断允许
	EA=1;								//打开总中断
	TR0=1;								//打开定时器
	LCD_Init();						//LCD1602初始化
	LCD_ShowString(1,0,"TIME:");
	LCD_ShowString(2,0,"CLOCK:");
	LCD_ShowString(1,5,time);				//显示初始时间
	LCD_ShowString(2,6,buzzr);			//显示闹钟时间
	LCD_WriteCommand(0x0c);					//关闭光标
while(1)								//主循环
{
	 if(!K1)							//按钮1功能切换
	 {
	 Delay(10000);						//延时防抖
		  if(!K1)
		  {
				two=0;					//功能时间指示变量清零
		  	  	if(moshi<2)				//模式切换
			  		moshi++;
				else
					moshi=0;
				switch(moshi)			//设置光标位置
				{
				case 0:	LCD_WriteCommand(0x0c);//正常模式，关闭光标
						break;
				case 1:	LCD_WriteCommand(0x0e);//模式1，打开光标
						LCD_SetCursor(1,6);	//设置光标位置
						break;
				case 2:	LCD_WriteCommand(0x0e);//模式2，打开光标
						LCD_SetCursor(2,6);	//设置光标位置
				}
		  }
		  while(!K1);				   	//等待按钮松开
	 }
	 if(moshi==1)						//模式1，调整时间
	 {
			if(!K2)						//下一个
			{
			   Delay(10000);			//延时防抖
			   	if(!K2)
				{
					if(two<2)
						two++;
					else
						two=0;
				}
				if(two==0)				//光标设置在小时位置
					{
					LCD_WriteCommand(0x0e);
					LCD_SetCursor(1,6);
					}
				if(two==1)					//光标设置在分钟位置
					{
					LCD_WriteCommand(0x0e);
					LCD_SetCursor(1,9);
					}
				if(two==2)					//光标设置在秒位置
					{
					LCD_WriteCommand(0x0e);
					LCD_SetCursor(1,12);
					}
				while(!K2);				//等待按钮松开
			}
			if(two==0)
				{
				if(!K3) 				//小时加一
					{
					Delay(10000);		//延时防抖
						if(!K3)
						{
							if(shi<23)	//限制小时最大值为23
							   shi++;	//小时加一
							else
								shi=0;
						}
					time[0]=shi/10+0x30;//计算
					time[1]=shi%10+0x30;
					LCD_ShowString(1,5,time);//显示
					LCD_SetCursor(1,6);		//保持光标位置
					while(!K3);
					}
				 if(!K4) 				//小时减一
					{
					Delay(10000);		//延时防抖
						if(!K4)
						{
							if(shi>0)
							   shi--;
							else
								shi=23;
						}
					time[0]=shi/10+0x30;//计算
					time[1]=shi%10+0x30;
					LCD_ShowString(1,5,time);//显示
					LCD_SetCursor(1,6);
					while(!K4);
					}
				}
			if(two==1)
				{
				if(!K3) 				//分钟加一
					{
					Delay(10000);		//延时防抖
						if(!K3)
						{
							if(fen<59)	//限制分钟最大值为59
							   	fen++;
							else
								fen=0;
						}
					time[3]=fen/10+0x30;//计算
					time[4]=fen%10+0x30;
					LCD_ShowString(1,5,time);//显示
					LCD_SetCursor(1,9);
					while(!K3);
					}
				 if(!K4) 				//分钟减一
					{
					Delay(10000);		//延时防抖
						if(!K4)
						{
							if(fen>0)
							   fen--;
							else
								fen=59;
						}
					time[3]=fen/10+0x30;//计算
					time[4]=fen%10+0x30;
					LCD_ShowString(1,5,time);//显示
					LCD_SetCursor(1,9);
					while(!K4);
					}
				}
			if(two==2)
				{
				if(!K3) 				//秒加一
					{
					Delay(10000);		//延时防抖
						if(!K3)
						{
							if(miao<59)	//限制分钟最大值为59
							   	miao++;
							else
								miao=0;
						}
					time[3]=miao/10+0x30;//计算
					time[4]=miao%10+0x30;
					LCD_ShowString(1,5,time);//显示
					LCD_SetCursor(1,9);
					while(!K3);
					}
				 if(!K4) 				//秒减一
					{
					Delay(10000);		//延时防抖
						if(!K4)
						{
							if(miao>0)
							   miao--;
							else
								miao=59;
						}
					time[3]=miao/10+0x30;//计算
					time[4]=miao%10+0x30;
					LCD_ShowString(1,5,time);//显示
					LCD_SetCursor(1,9);
					while(!K4);
					}
				}
		}
		if(moshi==2)					//模式2，调整闹钟
		{
			if(!K2)						//下一个
			{
			   Delay(10000);			//延时防抖
			   	if(!K2)
				{
					two=!two;			//切换次序
				}
				if(two==0)				//光标设置在小时
					{
					LCD_WriteCommand(0x0e);	//开启光标
					LCD_SetCursor(2,6);
					}
				else					//光标设置在分钟
					{
					LCD_WriteCommand(0x0e);	//开启光标
					LCD_SetCursor(2,9);
					}
				while(!K2);
			}
			if(two==0)
				{
				if(!K3) 				//小时加一
					{
					Delay(10000);		//延时防抖
						if(!K3)
						{
							if(buzzr_shi<23)//限制小时最大值为23
							   	buzzr_shi++;
							else
								buzzr_shi=0;
						}
					buzzr[0]=buzzr_shi/10+0x30;//计算
					buzzr[1]=buzzr_shi%10+0x30;
					LCD_ShowString(2,6,buzzr);//显示
					LCD_SetCursor(2,6);
					while(!K3);
					}
				 if(!K4) 				//小时减一
					{
					Delay(10000);		//延时防抖
						if(!K4)
						{
							if(buzzr_shi>0)
							   buzzr_shi--;
							else
								buzzr_shi=23;
						}
					//buzzr[0]=buzzr_sh;
					}}
				}}}
/*********************************LCD1602.h******************************************/	
#ifndef __LCD1602_H__
#define __LCD1602_H__

//用户调用函数：
void LCD_Init();
void LCD_ShowChar(unsigned char Line,unsigned char Column,char Char);
void LCD_ShowString(unsigned char Line,unsigned char Column,char *String);
void LCD_ShowNum(unsigned char Line,unsigned char Column,unsigned int Number,unsigned char Length);
void LCD_ShowSignedNum(unsigned char Line,unsigned char Column,int Number,unsigned char Length);
void LCD_ShowHexNum(unsigned char Line,unsigned char Column,unsigned int Number,unsigned char Length);
void LCD_ShowBinNum(unsigned char Line,unsigned char Column,unsigned int Number,unsigned char Length);
void LCD_WriteCommand(unsigned char Command);
void LCD_SetCursor(unsigned char Line,unsigned char Column);

#endif
/*********************************LCD1602.c********************************************/
#include <REGX52.H>

//引脚配置：
sbit LCD_RS=P2^6;
sbit LCD_RW=P2^5;
sbit LCD_EN=P2^7;
#define LCD_DataPort P0

//函数定义：
/**
  * @brief  LCD1602延时函数，12MHz调用可延时1ms
  * @param  无
  * @retval 无
  */
void LCD_Delay()
{
	unsigned char i, j;

	i = 2;
	j = 239;
	do
	{
		while (--j);
	} while (--i);
}

/**
  * @brief  LCD1602写命令
  * @param  Command 要写入的命令
  * @retval 无
  */
void LCD_WriteCommand(unsigned char Command)
{
	LCD_RS=0;
	LCD_RW=0;
	LCD_DataPort=Command;
	LCD_EN=1;
	LCD_Delay();
	LCD_EN=0;
	LCD_Delay();
}

/**
  * @brief  LCD1602写数据
  * @param  Data 要写入的数据
  * @retval 无
  */
void LCD_WriteData(unsigned char Data)
{
  LCD_RS=1;
	LCD_RW=0;
	LCD_DataPort=Data;
	LCD_EN=1;
	LCD_Delay();
	LCD_EN=0;
	LCD_Delay();
}

/**
  * @brief  LCD1602设置光标位置
  * @param  Line 行位置，范围：1~2
  * @param  Column 列位置，范围：1~16
  * @retval 无
  */
void LCD_SetCursor(unsigned char Line,unsigned char Column)
{
	if(Line==1)
	{
		LCD_WriteCommand(0x80|(Column-1));
	}
	else if(Line==2)
	{
		LCD_WriteCommand(0x80|(Column-1+0x40));
	}
}

/**
  * @brief  LCD1602初始化函数
  * @param  无
  * @retval 无
  */
void LCD_Init()
{
	LCD_WriteCommand(0x38);//八位数据接口，两行显示，5*7点阵
	LCD_WriteCommand(0x0c);//显示开，光标关，闪烁关
	LCD_WriteCommand(0x06);//数据读写操作后，光标自动加一，画面不动
	LCD_WriteCommand(0x01);//光标复位，清屏
}

/**
  * @brief  在LCD1602指定位置上显示一个字符
  * @param  Line 行位置，范围：1~2
  * @param  Column 列位置，范围：1~16
  * @param  Char 要显示的字符
  * @retval 无
  */
void LCD_ShowChar(unsigned char Line,unsigned char Column,char Char)
{
	LCD_SetCursor(Line,Column);
	LCD_WriteData(Char);
}

/**
  * @brief  在LCD1602指定位置开始显示所给字符串
  * @param  Line 起始行位置，范围：1~2
  * @param  Column 起始列位置，范围：1~16
  * @param  String 要显示的字符串
  * @retval 无
  */
void LCD_ShowString(unsigned char Line,unsigned char Column,char *String)
{
	unsigned char i;
	LCD_SetCursor(Line,Column);
	for(i=0;String[i]!='\0';i++)
	{
		LCD_WriteData(String[i]);
	}
}

/**
  * @brief  返回值=X的Y次方
  */
int LCD_Pow(int X,int Y)
{
	unsigned char i;
	int Result=1;
	for(i=0;i<Y;i++)
	{
		Result*=X;
	}
	return Result;
}

/**
  * @brief  在LCD1602指定位置开始显示所给数字
  * @param  Line 起始行位置，范围：1~2
  * @param  Column 起始列位置，范围：1~16
  * @param  Number 要显示的数字，范围：0~65535
  * @param  Length 要显示数字的长度，范围：1~5
  * @retval 无
  */
void LCD_ShowNum(unsigned char Line,unsigned char Column,unsigned int Number,unsigned char Length)
{
	unsigned char i;
	LCD_SetCursor(Line,Column);
	for(i=Length;i>0;i--)
	{
		LCD_WriteData(Number/LCD_Pow(10,i-1)%10+'0');
	}
}

/**
  * @brief  在LCD1602指定位置开始以有符号十进制显示所给数字
  * @param  Line 起始行位置，范围：1~2
  * @param  Column 起始列位置，范围：1~16
  * @param  Number 要显示的数字，范围：-32768~32767
  * @param  Length 要显示数字的长度，范围：1~5
  * @retval 无
  */
void LCD_ShowSignedNum(unsigned char Line,unsigned char Column,int Number,unsigned char Length)
{
	unsigned char i;
	unsigned int Number1;
	LCD_SetCursor(Line,Column);
	if(Number>=0)
	{
		LCD_WriteData('+');
		Number1=Number;
	}
	else
	{
		LCD_WriteData('-');
		Number1=-Number;
	}
	for(i=Length;i>0;i--)
	{
		LCD_WriteData(Number1/LCD_Pow(10,i-1)%10+'0');
	}
}

/**
  * @brief  在LCD1602指定位置开始以十六进制显示所给数字
  * @param  Line 起始行位置，范围：1~2
  * @param  Column 起始列位置，范围：1~16
  * @param  Number 要显示的数字，范围：0~0xFFFF
  * @param  Length 要显示数字的长度，范围：1~4
  * @retval 无
  */
void LCD_ShowHexNum(unsigned char Line,unsigned char Column,unsigned int Number,unsigned char Length)
{
	unsigned char i,SingleNumber;
	LCD_SetCursor(Line,Column);
	for(i=Length;i>0;i--)
	{
		SingleNumber=Number/LCD_Pow(16,i-1)%16;
		if(SingleNumber<10)
		{
			LCD_WriteData(SingleNumber+'0');
		}
		else
		{
			LCD_WriteData(SingleNumber-10+'A');
		}
	}
}

/**
  * @brief  在LCD1602指定位置开始以二进制显示所给数字
  * @param  Line 起始行位置，范围：1~2
  * @param  Column 起始列位置，范围：1~16
  * @param  Number 要显示的数字，范围：0~1111 1111 1111 1111
  * @param  Length 要显示数字的长度，范围：1~16
  * @retval 无
  */
void LCD_ShowBinNum(unsigned char Line,unsigned char Column,unsigned int Number,unsigned char Length)
{
	unsigned char i;
	LCD_SetCursor(Line,Column);
	for(i=Length;i>0;i--)
	{
		LCD_WriteData(Number/LCD_Pow(2,i-1)%2+'0');
	}
}
/****************************Delay.c*****************************************/
void Delay(unsigned int xms)
{
	unsigned char i,j;
	while(xms){
	_nop();
	i=4;
	j=205;
	
	do{
		
			while(--j);
		}while(--i);
	xms--;
}
}	
/*********************************Delay.h**********************************/
#ifndef __DELAY_H__
#define __DELAY_H__
void Delay(unsigned int xms);

#endif
