C51 COMPILER V8.08   MAIN                                                                  02/03/2016 15:41:56 PAGE 1   


C51 COMPILER V8.08, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE main.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /*
   2          DS18B20测温程序数码管显示
   3          可测温显示范围为-55℃ 至 +125℃
   4          
   5          */
   6          #include <reg52.h>
   7          #include <intrins.h>
   8          #define MAIN_Fosc               11059200UL      //宏定义主时钟HZ
   9          /*====================================
  10           自定义类型名
  11          ====================================*/
  12          typedef unsigned char INT8U;
  13          typedef unsigned char uchar;
  14          
  15          typedef unsigned int INT16U;
  16          typedef unsigned int uint;
  17          
  18          /*====================================
  19           硬件接口位声明
  20          ====================================*/
  21          sbit DS  = P2^2;   //DS18B20单总线
  22          sbit DU  = P2^6;   //数码管段选
  23          sbit WE  = P2^7;   //数码管位选
  24          /*显示负号*/
  25          uchar s=0;
  26          /*====================================
  27          共阴极数码管段选码
  28          ====================================*/
  29          uchar code table[]={ 
  30          //0             1        2     3     4     5     6     7     8
  31          0x3F, 0x06, 0x5B, 0x4F, 0x66, 0x6D, 0x7D, 0x07, 0x7F,
  32          //9     A     B    C     D         E     F              -        .        关显示
  33          0x6F, 0x77, 0x7C, 0x39, 0x5E, 0x79, 0x71, 0x40, 0x80, 0x00
  34                             };
  35          
  36          /*====================================
  37          数码管位选码
  38          ====================================*/
  39                                            //第1位       2位       3位    4位   5位      6位       7位   8位
  40          uchar code T_COM[] = {0xfe, 0xfd, 0xfb, 0xf7, 0xef, 0xdf, 0xbf, 0x7f};//数码管位码
  41          
  42          /*====================================
  43          函数：void Delay_Ms(INT16U ms)
  44          参数：ms，毫秒延时形参
  45          描述：12T 51单片机自适应主时钟毫秒级延时函数
  46          ====================================*/
  47          void Delay_Ms(INT16U ms)
  48          {
  49   1           INT16U i;
  50   1               do{
  51   2                    i = MAIN_Fosc / 96000; 
  52   2                        while(--i);   //96T per loop
  53   2           }while(--ms);
  54   1      }
  55          /*us延时函数，执行一次US--所需6.5us进入一次函数需要11.95us*/
C51 COMPILER V8.08   MAIN                                                                  02/03/2016 15:41:56 PAGE 2   

  56          void Delay_us(uchar us)
  57          {
  58   1              while(us--);    
  59   1      }
  60          /*====================================
  61          函数：void Display(unsigned long Value)
  62          参数：Value,显示值 32位
  63          描述：
  64          ====================================*/
  65          void Display(unsigned long Value)               
  66          {
  67   1              uchar i=0;
  68   1      //第一位数码管
  69   1      //------------------------------
  70   1              if(s == 0);                                                     //如果为负数则不显示
  71   1              else
  72   1              {               
  73   2                      DU = 0;                                                 //关闭段选
  74   2                      P0 = s;         
  75   2                      DU = 1;                                                 //打开段选
  76   2                      DU = 0;                                                 //关闭段选
  77   2              
  78   2                      WE = 0;                                         //关闭位选
  79   2                      P0 = T_COM[i++];                        
  80   2                      WE = 1;                                         //打开位选
  81   2                      WE = 0;                                         //关闭位选
  82   2                      Delay_Ms(1);
  83   2              }
  84   1      //第二位数码管
  85   1      //------------------------------
  86   1              if(Value < 1000000);                       //如果温度值百位为0则不显示
  87   1              else
  88   1              {
  89   2                      DU = 0;                                                 //关闭段选
  90   2                      P0 = table[Value/1000000];      
  91   2                      DU = 1;                                                 //打开段选
  92   2                      DU = 0;                                                 //关闭段选
  93   2              
  94   2                      WE = 0;                                         //关闭位选
  95   2                      P0 = T_COM[i++];                                
  96   2                      WE = 1;                                         //打开位选
  97   2                      WE = 0;                                         //关闭位选
  98   2                      Delay_Ms(1);
  99   2              }
 100   1      //第三位数码管
 101   1      //------------------------------
 102   1              if(Value < 100000);                                     
 103   1              else
 104   1              {
 105   2                      DU = 0;                                                 //关闭段选
 106   2                      P0 = table[Value%1000000/100000];               //数码管显示百位
 107   2                      DU = 1;                                                 //打开段选
 108   2                      DU = 0;                                                 //关闭段选
 109   2              
 110   2                      WE = 0;                                         //关闭位选
 111   2                      P0 = T_COM[i++];                                
 112   2                      WE = 1;                                         //打开位选
 113   2                      WE = 0;                                         //关闭位选
 114   2                      Delay_Ms(1);
 115   2              }
 116   1      //第四位数码管
 117   1      //-------------------------------
C51 COMPILER V8.08   MAIN                                                                  02/03/2016 15:41:56 PAGE 3   

 118   1              DU = 0;
 119   1      
 120   1              P0 = table[Value%100000/10000]|0x80;//显示温度小数点，温度值个位显示
 121   1      
 122   1              DU = 1;
 123   1              DU = 0;
 124   1      
 125   1              WE = 0;
 126   1              P0 = T_COM[i++];                
 127   1              WE = 1;
 128   1              WE = 0;
 129   1              Delay_Ms(1);
 130   1      //第五位数码管
 131   1      //-------------------------------
 132   1              DU = 0;                                                 //关闭段选
 133   1              P0 = table[Value%10000/1000];   
 134   1              DU = 1;                                                 //打开段选
 135   1              DU = 0;                                                 //关闭段选
 136   1      
 137   1              WE = 0;                                         //关闭位选
 138   1              P0 = T_COM[i++];                                
 139   1              WE = 1;                                         //打开位选
 140   1              WE = 0;                                         //关闭位选
 141   1              Delay_Ms(1);
 142   1      //第六位数码管
 143   1      //-------------------------------
 144   1              if((Value%100/10) == 0 && (Value%1000/100) == 0 ); 
 145   1              else
 146   1              {
 147   2                      DU = 0;                                                 //关闭段选
 148   2                      P0 = table[Value%1000/100];     
 149   2                      DU = 1;                                                 //打开段选
 150   2                      DU = 0;                                                 //关闭段选
 151   2              
 152   2                      WE = 0;                                         //关闭位选
 153   2                      P0 = T_COM[i++];                                
 154   2                      WE = 1;                                         //打开位选
 155   2                      WE = 0;                                         //关闭位选
 156   2                      Delay_Ms(1);
 157   2              }
 158   1      //第七位数码管
 159   1      //-------------------------------
 160   1              if((Value%10) == 0 && (Value%100/10) == 0);
 161   1              else
 162   1              {
 163   2                      DU = 0;                                                 //关闭段选
 164   2                      P0 = table[Value%100/10];       
 165   2                      DU = 1;                                                 //打开段选
 166   2                      DU = 0;                                                 //关闭段选
 167   2              
 168   2                      WE = 0;                                         //关闭位选
 169   2                      P0 = T_COM[i++];                                
 170   2                      WE = 1;                                         //打开位选
 171   2                      WE = 0;                                         //关闭位选
 172   2                      Delay_Ms(1);
 173   2              }
 174   1      //第八位数码管
 175   1      //-------------------------------
 176   1              if((Value%10) == 0 );
 177   1              else
 178   1              {
 179   2                      DU = 0;                                                 //关闭段选
C51 COMPILER V8.08   MAIN                                                                  02/03/2016 15:41:56 PAGE 4   

 180   2                      P0 = table[Value%10];   
 181   2                      DU = 1;                                                 //打开段选
 182   2                      DU = 0;                                                 //关闭段选
 183   2              
 184   2                      WE = 0;                                         //关闭位选
 185   2                      P0 = T_COM[i++];                                
 186   2                      WE = 1;                                         //打开位选
 187   2                      WE = 0;                                         //关闭位选
 188   2                      Delay_Ms(1);
 189   2              }
 190   1      }
 191          
 192          /*单总线初始化时序*/
 193          bit ds_init()
 194          {
 195   1              bit i;
 196   1              DS = 1;
 197   1              _nop_();
 198   1              DS = 0;
 199   1              Delay_us(75); //拉低总线499.45us 挂接在总线上的18B20将会全部被复位
 200   1              DS = 1; //释放总线
 201   1              Delay_us(4); //延时37.95us 等待18B20发回存在信号
 202   1              i = DS;
 203   1              Delay_us(20); //141.95us
 204   1              DS = 1;
 205   1              _nop_();
 206   1              return (i);
 207   1      }
 208          /*写一个字节*/
 209          void write_byte(uchar dat)
 210          {
 211   1              uchar i;
 212   1              for(i=0;i<8;i++)
 213   1              {
 214   2                      DS = 0;
 215   2                      _nop_();//产生些时序
 216   2                      DS = dat & 0x01;
 217   2                      Delay_us(10);//76.95us
 218   2                      DS = 1; //释放总线准备下一次数据写入
 219   2                      _nop_();
 220   2                      dat >>= 1;
 221   2              }
 222   1      }
 223          
 224          uchar read_byte()
 225          {
 226   1              uchar i, j, dat;
 227   1              for(i=0;i<8;i++)
 228   1              {
 229   2                      DS = 0;
 230   2                      _nop_();//产生读时序
 231   2                      DS = 1;
 232   2                      _nop_();//释放总线
 233   2                      j = DS;
 234   2                      Delay_us(10);//76.95us
 235   2                      DS = 1;
 236   2                      _nop_();
 237   2                      dat = (j<<7)|(dat>>1);  
 238   2              }
 239   1              return (dat);
 240   1      }
 241          void main()
C51 COMPILER V8.08   MAIN                                                                  02/03/2016 15:41:56 PAGE 5   

 242          {
 243   1              unsigned long temp;
 244   1              uint i;
 245   1              uchar L, M;
 246   1              ds_init();//初始化DS18B20
 247   1              write_byte(0xcc);//发送跳跃ROM指令
 248   1              write_byte(0x4e);//写暂存器指令
 249   1              write_byte(0x7f);//TH用户字节
 250   1              write_byte(0xf7);//TL用户字节
 251   1              write_byte(0x7f);//配置工作在12位模式下
 252   1              ds_init();//初始化DS18B20
 253   1              write_byte(0xcc);//发送跳跃ROM指令 
 254   1              write_byte(0x48);//拷贝暂存器到温度传感器的EEPROM中
 255   1              while(1)
 256   1              {
 257   2                      ds_init();//初始化DS18B20
 258   2                      write_byte(0xcc);//发送跳跃ROM指令
 259   2                      write_byte(0x44);//发送温度转换指令
 260   2                      ds_init();//初始化DS18B20
 261   2                      write_byte(0xcc);//发送跳跃ROM指令
 262   2                      write_byte(0xbe);//读取DS18B20暂存器值
 263   2                      L = read_byte();
 264   2                      M = read_byte();
 265   2                      //模拟显示-55度，实际测温需注解掉下面这两句
 266   2                      //M = 0xfe;
 267   2                      //L = 0x6f;
 268   2      
 269   2                      i = M;
 270   2                      i <<= 8;
 271   2                      i |= L;         
 272   2                      if(M >= 0x08)   //判断是否为负数
 273   2                      { 
 274   3                              i = ~i + 1;//负数是以补码的形式存放的需要我们需要取反加1
 275   3                              s = 0x40;  //显示负数符号
 276   3                      }
 277   2                      else s = 0;        //为正数则不显示                             
 278   2                      temp = i * 0.0625 * 10000; //浮点型数据转换
 279   2                      Display(temp);
 280   2              }
 281   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    855    ----
   CONSTANT SIZE    =     27    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      1      11
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
