C51 COMPILER V9.00   MAIN                                                                  08/18/2017 16:50:24 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE main.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /*
   2          ****************串口显示DS18B20温度值************************
   3          DS18B20数据接口为P2.2
   4          打开串口后比特率设置为9600
   5          接收模式为文本模式
   6          */
   7          #include <reg52.h>
   8          #include <intrins.h>
   9          #include <stdio.h>
  10          #define MAIN_Fosc               11059200UL      //宏定义主时钟HZ
  11          /*====================================
  12           自定义类型名
  13          ====================================*/
  14          typedef unsigned char INT8U;
  15          typedef unsigned char uchar;
  16          
  17          typedef unsigned int INT16U;
  18          typedef unsigned int uint;
  19          
  20          /*====================================
  21           硬件接口位声明
  22          ====================================*/
  23          sbit DS  = P2^2;   //DS18B20单总线
  24          
  25          
  26          /*====================================
  27          函数：void Delay_Ms(INT16U ms)
  28          参数：ms，毫秒延时形参
  29          描述：12T 51单片机自适应主时钟毫秒级延时函数
  30          ====================================*/
  31          void Delay_Ms(INT16U ms)
  32          {
  33   1           INT16U i;
  34   1               do{
  35   2                    i = MAIN_Fosc / 96000; 
  36   2                        while(--i);   //96T per loop
  37   2           }while(--ms);
  38   1      }
  39          /*us延时函数，执行一次US--所需6.5us进入一次函数需要11.95us*/
  40          void Delay_us(uchar us)
  41          {
  42   1              while(us--);    
  43   1      }
  44          
  45          /*单总线初始化时序*/
  46          bit ds_init()
  47          {
  48   1              bit i;
  49   1              DS = 1;
  50   1              _nop_();
  51   1              DS = 0;
  52   1              Delay_us(75); //拉低总线499.45us 挂接在总线上的18B20将会全部被复位
  53   1              DS = 1; //释放总线
  54   1              Delay_us(4); //延时37.95us 等待18B20发回存在信号
  55   1              i = DS;
C51 COMPILER V9.00   MAIN                                                                  08/18/2017 16:50:24 PAGE 2   

  56   1              Delay_us(20); //141.95us
  57   1              DS = 1;
  58   1              _nop_();
  59   1              return (i);
  60   1      }
  61          /*写一个字节*/
  62          void write_byte(uchar dat)
  63          {
  64   1              uchar i;
  65   1              for(i=0;i<8;i++)
  66   1              {
  67   2                      DS = 0;
  68   2                      _nop_();//产生些时序
  69   2                      DS = dat & 0x01;
  70   2                      Delay_us(10);//76.95us
  71   2                      DS = 1; //释放总线准备下一次数据写入
  72   2                      _nop_();
  73   2                      dat >>= 1;
  74   2              }
  75   1      }
  76          
  77          uchar read_byte()
  78          {
  79   1              uchar i, j, dat;
  80   1              for(i=0;i<8;i++)
  81   1              {
  82   2                      DS = 0;
  83   2                      _nop_();//产生读时序
  84   2                      DS = 1;
  85   2                      _nop_();//释放总线
  86   2                      j = DS;
  87   2                      Delay_us(10);//76.95us
  88   2                      DS = 1;
  89   2                      _nop_();
  90   2                      dat = (j<<7)|(dat>>1);  
  91   2              }
  92   1              return (dat);
  93   1      }
  94          
  95          /*串口初始化，比特率9600*/
  96          void UART_Init()
  97          {
  98   1              TMOD |= 0x20;   //T1工作模式2  8位自动重装
  99   1              TH1 = 0xfd;
 100   1              TL1 = 0xfd;     //比特率9600
 101   1              TR1 = 1;                //启动T1定时器
 102   1              SM0 = 0;
 103   1              SM1 = 1;                //串口工作方式1 10位异步
 104   1      }
 105          
 106          union _Temp{  //联合体类型定义
 107                  uchar c[2];     //其中c[0]温度的高字节，c[1]存放温度的低字节
 108                  uint x; //x就正好是DS18B20的温度值
 109          };
 110          
 111          void main()
 112          {
 113   1              union _Temp temp;//联合体变量定义
 114   1              float i;
 115   1              UART_Init(); //串口初始化
 116   1              TI = 1;//使用printf()puts()前都应软件置位TI = 1；
 117   1      
C51 COMPILER V9.00   MAIN                                                                  08/18/2017 16:50:24 PAGE 3   

 118   1              ds_init();//初始化DS18B20
 119   1              write_byte(0xcc);//发送跳跃ROM指令
 120   1              write_byte(0x44);//发送温度转换指令
 121   1              Delay_Ms(1000);
 122   1              while(1)
 123   1              {
 124   2                      ds_init();//初始化DS18B20
 125   2                      write_byte(0xcc);//发送跳跃ROM指令
 126   2                      write_byte(0x44);//发送温度转换指令
 127   2                      ds_init();//初始化DS18B20
 128   2                      write_byte(0xcc);//发送跳跃ROM指令
 129   2                      write_byte(0xbe);//读取DS18B20暂存器值
 130   2                      temp.c[1] = read_byte();//温度低字节
 131   2                      temp.c[0] = read_byte();//温度高字节                                            
 132   2                      i = temp.x * 0.0625;//还原小数
 133   2                      printf("温度: %4.2f", i); //保留小数点后两位输出
 134   2                      printf("℃ \n");
 135   2                      Delay_Ms(5000);//5秒发送一次
 136   2              }
 137   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    262    ----
   CONSTANT SIZE    =     17    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       6
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
